# 多租户考虑因素

德鲁伊通常用于为面向用户的数据应用程序提供支持，其中多租户是一项重要的要求。本文档概述了德鲁伊的多租户存储和查询功能。

## 共享数据源或每个租户的数据源？

数据源是数据库表的德鲁伊等价物。多租户工作负载可以为每个租户使用单独的数据源，也可以使用“tenant_id”维度在租户之间共享一个或多个数据源。在决定哪条路径下降时，请考虑每条路径都有利有弊。

每个租户的数据源优势：

- 每个数据源都可以拥有自己的模式，自己的回填，自己的分区规则以及自己的数据加载和到期规则。
- 查询可以更快，因为对于典型租户的查询，要检查的段将更少。
- 你获得了最大的灵活性。

共享数据源的优点：

- 每个数据源都需要自己的JVM来进行实时索引。
- 每个数据源都需要自己的YARN资源用于Hadoop批处理作业。
- 每个数据源都需要磁盘上自己的段文件。
- 由于这些原因，拥有大量小型数据源可能会浪费。

一个折衷方案是使用多个数据源，但数量少于租户。例如，您可以让一些租户使用分区规则A，一些租户使用分区规则B; 您可以使用两个数据源并在它们之间拆分租户。

## 对共享数据源进行分区

如果多租户群集使用共享数据源，则大多数查询可能会在“tenant_id”维度上进行过滤。当租户对数据进行良好分区时，这些类型的查询效果最佳。有几种方法可以实现这一目标。

使用批量索引，您可以使用[单维分区](http://druid.io/docs/0.12.3/indexing/batch-ingestion.html#single-dimension-partitioning) 按tenant_id对数据进行分区。德鲁伊总是首先按时间划分，但每个时间段内的辅助分区将位于tenant_id上。

使用实时索引，您有几个选择。

1. 预先在tenant_id上进行分区。你可以通过调整你发送给德鲁伊的流来做到这一点。如果您正在使用Kafka，那么您可以通过tenant_id的哈希值让您的Kafka生产者对您的主题进行分区。如果您正在使用Tranquility，那么您可以定义自定义[分区程序](http://static.druid.io/tranquility/api/latest/#com.metamx.tranquility.partition.Partitioner)。
2. 定期重新索引旧数据。您可以使用[“dataSource”输入规范](http://druid.io/docs/0.12.3/ingestion/hadoop.html#datasource)执行此操作。您可以将其与单维分区配合使用以重新分区数据。

## 自定义数据分发

Druid还通过提供可配置的数据分发方式来支持多租户。可以将德鲁伊的历史节点配置为[层](http://druid.io/docs/0.12.3/operations/rule-configuration.html)，并且 可以设置[规则](http://druid.io/docs/0.12.3/operations/rule-configuration.html)以确定哪些段进入哪些层。一个用例是最近的数据往往比旧数据更频繁地访问。Tiering使更新的段可以托管在功能更强大的硬件上，以获得更好的性能。最近段的第二个副本可以在更便宜的硬件（不同的层）上复制，旧的段也可以存储在该层上。

## 支持高查询并发性

德鲁伊的基本计算单位是一个[细分](http://druid.io/docs/0.12.3/design/segments.html)。节点并行扫描段，给定节点可以`druid.processing.numThreads`同时扫描。要并行处理更多数据并提高性能，可以将更多内核添加到群集中。德鲁伊片段的大小应使得任何给定片段的任何计算都应在最多500毫秒内完成。

Druid内部存储扫描优先级队列中的段的请求。如果给定查询需要扫描的段数多于群集中可用处理器的总数，并且许多同样昂贵的查询同时运行，我们不希望任何查询被淘汰。德鲁伊的内部处理逻辑将扫描一个查询中的一组段，并在扫描完成后立即释放资源。这允许扫描来自另一个查询的第二组片段。通过使段计算时间非常小，我们确保不断地产生资源，并且正在处理与不同查询相关的段。

德鲁伊查询可以选择`priority`在[查询上下文中](http://druid.io/docs/0.12.3/querying/query-context.html)设置标志。已知速度慢的查询（下载或报告样式查询）可以取消优先级，更多交互式查询可以具有更高的优先级。

代理节点也可以专用于给定的层。例如，一组代理节点可以专用于快速交互式查询，第二组代理节点可以专用于较慢的报告查询。Druid还提供了一个[路由器](http://druid.io/docs/0.12.3/development/router.html) 节点，可以根据各种查询参数（数据源，间隔等）将查询路由到不同的代理。