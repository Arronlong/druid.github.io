# 协调器节点

### 组态

有关协调器节点配置，请参阅[协调器配置](http://druid.io/docs/0.12.3/configuration/index.html#coordinator)。

### HTTP端点

有关协调器支持的API端点列表，请参阅[协调器API](http://druid.io/docs/0.12.3/operations/api-reference.html#coordinator)。

### 概观

德鲁伊协调员节点主要负责分段管理和分发。更具体地，德鲁伊协调器节点与历史节点通信以基于配置来加载或丢弃段。Druid协调员负责加载新段，删除过时段，管理段复制以及平衡段负载。

德鲁伊协调员定期运行，每次运行之间的时间是可配置参数。每次德鲁伊协调员运行时，它会在决定采取适当的行动之前评估群集的当前状态。与代理和历史节点类似，Druid协调器维护与Zookeeper集群的连接以获取当前集群信息。协调器还维护与数据库的连接，该数据库包含有关可用段和规则的信息。可用段存储在段表中，并列出应在群集中加载的所有段。规则存储在规则表中，并指示应如何处理段。

在历史节点为任何未分配的段提供服务之前，每个层的可用历史节点首先按容量排序，最少的容量服务器具有最高优先级。未分配的段始终分配给具有最小容量的节点，以维持节点之间的平衡水平。协调器在为其分配新段时不直接与历史节点通信; 相反，协调器在历史节点的加载队列路径下创建关于新段的一些临时信息。一旦看到此请求，历史节点将加载该段并开始为其提供服务。

### 运行

```text
io.druid.cli.Main server coordinator
```

### 规则

可以根据一组规则自动从群集中加载和删除段。有关规则的更多信息，请参阅[规则配置](http://druid.io/docs/0.12.3/operations/rule-configuration.html)。

### 清理细分

每次运行时，Druid协调器都会将数据库中可用数据库段的列表与集群中的当前段进行比较。不在数据库中但仍在群集中提供的段将被标记并附加到删除列表。被黯然失色的细分（他们的版本太旧，他们的数据已被更新的细分替换）也被删除了。请注意，如果数据库中的所有段都被删除（或标记为未使用），则协调员不会从历史记录中删除任何内容。这样做是为了防止竞争条件，如果协调器在第一次完成轮询数据库的可用段之前开始运行清理，并且认为没有段，则协调器将丢弃所有段。

### 细分可用性

如果历史节点由于任何原因重新启动或变得不可用，则德鲁伊协调器将注意到节点已丢失并将该节点所服务的所有段视为丢弃。给定足够的时间段，可以将段重新分配给集群中的其他历史节点。但是，删除的每个段都不会立即被遗忘。相反，存在一种过渡数据结构，其存储具有关联生命期的所有丢弃的段。生命周期表示协调员不会重新分配丢弃的段的时间段。因此，如果历史节点在短时间内变得不可用并且再次可用，则历史节点将启动并从其高速缓存中提供段，而不在集群中重新分配任何段。

### 平衡段负载

为了确保在群集中的历史节点之间均匀分布段，协调器节点将在每次协调器运行时找到每个历史节点所服务的所有段的总大小。对于集群中的每个历史节点层，协调器节点将确定具有最高利用率的历史节点和具有最低利用率的历史节点。计算两个节点之间利用率的百分比差异，如果结果超过某个阈值，则将从最高利用节点移动到最低利用节点。每次协调器运行时，可以从一个节点移动到另一个节点的段数有一个可配置的限制。

### 协调员控制台

Druid协调器公开了一个用于显示集群信息和规则配置的Web GUI。协调器启动后，可以通过以下方式访问控制台：

```text
http://<COORDINATOR_IP>:<COORDINATOR_PORT>
```

存在完整的集群视图（仅显示实时和历史节点），以及各个历史节点，数据源和段本身的视图。细分信息可以以原始JSON格式显示，也可以作为可排序和可过滤表格的一部分显示。

协调器控制台还公开了创建和编辑规则的界面。在segment数据库中配置的所有有效数据源以及默认数据源都可用于配置。可以添加，删除或编辑不同类型的规则。

### 常问问题

1. **客户端是否曾联系协调节点？**

   协调员不参与查询。

   历史节点永远不会直接联系协调节点。德鲁伊协调员告诉历史节点通过Zookeeper加载/删除数据，但历史节点完全不知道协调器。

   经纪人也从不联系协调员。经纪人基于历史节点通过ZK公开的元数据来理解数据拓扑，并且完全不知道协调器。

2. **协调器节点在其他进程之前或之后启动是否重要？**

   否。如果未启动德鲁伊协调员，则不会在群集中加载新段，并且不会删除过期段。但是，协调器节点可以随时启动，并且在可配置的延迟之后，将开始运行协调器任务。

   这也意味着如果您有一个工作集群并且所有协调器都死了，集群将继续运行，它将不会遇到对其数据拓扑的任何更改。