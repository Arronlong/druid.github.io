# 经纪人

### 组态

有关代理节点配置，请参阅[代理配置](http://druid.io/docs/0.12.3/configuration/index.html#broker)。

### HTTP端点

有关Broker支持的API端点列表，请参阅[Broker API](http://druid.io/docs/0.12.3/operations/api-reference.html#broker)。

### 概观

如果要运行分布式群集，Broker是将查询路由到的节点。它了解发布到ZooKeeper的元数据，了解哪些节点存在于哪些节点上并路由查询，以便它们到达正确的节点。此节点还将来自所有单个节点的结果集合并在一起。启动时，Realtime节点会宣布自己以及它们在Zookeeper中提供的段。

### 运行

```text
io.druid.cli.Main server broker
```

### 转发查询

大多数德鲁伊查询都包含一个间隔对象，它指示请求数据的时间跨度。同样，德鲁伊[细分](http://druid.io/docs/0.12.3/design/segments.html)被划分为包含一段时间间隔的数据，并且细分在整个集群中分布。考虑一个包含7个段的简单数据源，其中每个段包含一周中给定日期的数据。对数据源发出超过一天数据的任何查询都将触发多个段。这些段可能会分布在多个节点上，因此查询可能会遇到多个节点。

要确定将查询转发到哪些节点，Broker节点首先根据Zookeeper中的信息构建世界视图。Zookeeper维护有关[历史](http://druid.io/docs/0.12.3/design/historical.html)和[实时](http://druid.io/docs/0.12.3/design/realtime.html)节点及其服务的段的信息。对于Zookeeper中的每个数据源，Broker节点都会构建段的时间轴以及为它们提供服务的节点。当收到特定数据源和间隔的查询时，Broker节点执行查询与查询间隔的查询数据源关联的时间线，并检索包含查询数据的节点。Broker节点然后将查询转发到所选节点。

### 高速缓存

代理节点使用具有LRU高速缓存失效策略的高速缓存。代理缓存存储每段结果。缓存可以是每个代理节点的本地缓存，也可以使用外部分布式缓存（如[memcached）](http://memcached.org/)在多个节点之间共享。每次代理节点收到查询时，它首先将查询映射到一组段。这些段结果的子集可能已经存在于缓存中，并且结果可以直接从缓存中提取。对于缓存中不存在的任何段结果，代理节点将查询转发到历史节点。历史节点返回结果后，代理会将这些结果存储在缓存中。实时段从不被缓存，因此对实时数据的请求将始终转发到实时节点。实时数据不断变化，缓存结果将是不可靠的。