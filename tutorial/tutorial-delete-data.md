# 教程：删除数据

本教程演示了如何删除现有数据。

对于本教程，我们假设您已经按照[单机快速入门](http://druid.io/docs/0.12.3/tutorials/index.html)中的描述下载了Druid，并让它在本地计算机上运行。

完成[教程：](http://druid.io/docs/0.12.3/tutorials/tutorial-retention.html)强烈建议先[配置保留](http://druid.io/docs/0.12.3/tutorials/tutorial-retention.html)，因为我们将在本教程中使用保留规则。

## 加载初始数据

在本教程中，我们将使用Wikipedia编辑数据，以及创建每小时段的索引规范。此规范位于`examples/deletion-index.json`，它创建一个名为的数据源`deletion-tutorial`。

让我们加载这个初始数据：

```bash
curl -X 'POST' -H 'Content-Type:application/json' -d @examples/deletion-index.json http://localhost:8090/druid/indexer/v1/task
```

加载完成后，在浏览器中打开http：// localhost：8081 /＃/ datasources / deletion-tutorial。

## 如何永久删除数据

永久删除德鲁伊片段有两个步骤：

1. 该段必须首先标记为“未使用”。当按照保留规则删除段时，以及用户通过Coordinator API手动禁用段时，会发生这种情况。本教程将涵盖这两种情况。
2. 在段被标记为“未使用”之后，Kill Task将删除Druid元数据存储中的任何“未使用”段以及深度存储。

现在让我们删除一些段，首先使用加载规则，然后手动删除。

## 使用加载规则删除一些数据

与之前的保留教程一样，`deletion-tutorial`数据源中当前有24个段。

单击`edit rules`页面左上角带有铅笔图标的按钮。

将出现规则配置窗口。输入`tutorial`user和changelog注释字段。

现在单击`+ Add a rule`按钮两次。

在`rule #1`顶部的框中，单击`Load`,, 在间隔框中`Interval`输入`2015-09-12T12:00:00.000Z/2015-09-13T00:00:00.000Z`，然后单击`+ _default_tier replicant`。

在`rule #2`底部的框中，单击`Drop`和`Forever`。

这将导致前12个段`deletion-tutorial`被删除。但是，这些丢弃的段不会从深层存储中删除。

通过列出以下内容，您可以看到所有24个段仍然存在于深层存储中`var/druid/segments/deletion-tutorial`：

```bash
$ ls -l1 var/druid/segments/deletion-tutorial/
2015-09-12T00:00:00.000Z_2015-09-12T01:00:00.000Z
2015-09-12T01:00:00.000Z_2015-09-12T02:00:00.000Z
2015-09-12T02:00:00.000Z_2015-09-12T03:00:00.000Z
2015-09-12T03:00:00.000Z_2015-09-12T04:00:00.000Z
2015-09-12T04:00:00.000Z_2015-09-12T05:00:00.000Z
2015-09-12T05:00:00.000Z_2015-09-12T06:00:00.000Z
2015-09-12T06:00:00.000Z_2015-09-12T07:00:00.000Z
2015-09-12T07:00:00.000Z_2015-09-12T08:00:00.000Z
2015-09-12T08:00:00.000Z_2015-09-12T09:00:00.000Z
2015-09-12T09:00:00.000Z_2015-09-12T10:00:00.000Z
2015-09-12T10:00:00.000Z_2015-09-12T11:00:00.000Z
2015-09-12T11:00:00.000Z_2015-09-12T12:00:00.000Z
2015-09-12T12:00:00.000Z_2015-09-12T13:00:00.000Z
2015-09-12T13:00:00.000Z_2015-09-12T14:00:00.000Z
2015-09-12T14:00:00.000Z_2015-09-12T15:00:00.000Z
2015-09-12T15:00:00.000Z_2015-09-12T16:00:00.000Z
2015-09-12T16:00:00.000Z_2015-09-12T17:00:00.000Z
2015-09-12T17:00:00.000Z_2015-09-12T18:00:00.000Z
2015-09-12T18:00:00.000Z_2015-09-12T19:00:00.000Z
2015-09-12T19:00:00.000Z_2015-09-12T20:00:00.000Z
2015-09-12T20:00:00.000Z_2015-09-12T21:00:00.000Z
2015-09-12T21:00:00.000Z_2015-09-12T22:00:00.000Z
2015-09-12T22:00:00.000Z_2015-09-12T23:00:00.000Z
2015-09-12T23:00:00.000Z_2015-09-13T00:00:00.000Z
```

## 手动禁用细分

我们现在手动禁用一个段。这会将段标记为“未使用”，但不会将其从深层存储中删除。

在http：// localhost：8081 /＃/ datasources / deletion-tutorial上，单击左侧的其余段之一以获取有关该段的完整详细信息：

![段](http://druid.io/docs/0.12.3/tutorials/img/tutorial-deletion-01.png)

信息框的顶部显示完整的细分ID，例如`deletion-tutorial_2016-06-27T14:00:00.000Z_2016-06-27T15:00:00.000Z_2018-07-27T22:57:00.110Z`小时14的细分。

让我们通过向协调器发送以下DELETE请求来禁用小时14段，其中{SEGMENT-ID}是信息框中显示的完整段ID：

```bash
curl -XDELETE http://localhost:8081/druid/coordinator/v1/datasources/deletion-tutorial/segments/{SEGMENT-ID}
```

该命令完成后，您应该看到已禁用小时14的段：

![细分2](http://druid.io/docs/0.12.3/tutorials/img/tutorial-deletion-02.png)

请注意，小时14段仍处于深度存储中：

```bash
$ ls -l1 var/druid/segments/deletion-tutorial/
2015-09-12T00:00:00.000Z_2015-09-12T01:00:00.000Z
2015-09-12T01:00:00.000Z_2015-09-12T02:00:00.000Z
2015-09-12T02:00:00.000Z_2015-09-12T03:00:00.000Z
2015-09-12T03:00:00.000Z_2015-09-12T04:00:00.000Z
2015-09-12T04:00:00.000Z_2015-09-12T05:00:00.000Z
2015-09-12T05:00:00.000Z_2015-09-12T06:00:00.000Z
2015-09-12T06:00:00.000Z_2015-09-12T07:00:00.000Z
2015-09-12T07:00:00.000Z_2015-09-12T08:00:00.000Z
2015-09-12T08:00:00.000Z_2015-09-12T09:00:00.000Z
2015-09-12T09:00:00.000Z_2015-09-12T10:00:00.000Z
2015-09-12T10:00:00.000Z_2015-09-12T11:00:00.000Z
2015-09-12T11:00:00.000Z_2015-09-12T12:00:00.000Z
2015-09-12T12:00:00.000Z_2015-09-12T13:00:00.000Z
2015-09-12T13:00:00.000Z_2015-09-12T14:00:00.000Z
2015-09-12T14:00:00.000Z_2015-09-12T15:00:00.000Z
2015-09-12T15:00:00.000Z_2015-09-12T16:00:00.000Z
2015-09-12T16:00:00.000Z_2015-09-12T17:00:00.000Z
2015-09-12T17:00:00.000Z_2015-09-12T18:00:00.000Z
2015-09-12T18:00:00.000Z_2015-09-12T19:00:00.000Z
2015-09-12T19:00:00.000Z_2015-09-12T20:00:00.000Z
2015-09-12T20:00:00.000Z_2015-09-12T21:00:00.000Z
2015-09-12T21:00:00.000Z_2015-09-12T22:00:00.000Z
2015-09-12T22:00:00.000Z_2015-09-12T23:00:00.000Z
2015-09-12T23:00:00.000Z_2015-09-13T00:00:00.000Z
```

## 运行kill任务

现在我们已经禁用了一些段，我们可以提交一个Kill Task，它将从元数据和深层存储中删除已禁用的段。

已提供杀戮任务规范`examples/deletion-kill.json`。使用以下命令将此任务提交给Overlord：

```bash
curl -X 'POST' -H 'Content-Type:application/json' -d @examples/deletion-kill.json http://localhost:8090/druid/indexer/v1/task
```

完成此任务后，您可以看到已禁用的段已从深层存储中删除：

```bash
$ ls -l1 var/druid/segments/deletion-tutorial/
2015-09-12T12:00:00.000Z_2015-09-12T13:00:00.000Z
2015-09-12T13:00:00.000Z_2015-09-12T14:00:00.000Z
2015-09-12T15:00:00.000Z_2015-09-12T16:00:00.000Z
2015-09-12T16:00:00.000Z_2015-09-12T17:00:00.000Z
2015-09-12T17:00:00.000Z_2015-09-12T18:00:00.000Z
2015-09-12T18:00:00.000Z_2015-09-12T19:00:00.000Z
2015-09-12T19:00:00.000Z_2015-09-12T20:00:00.000Z
2015-09-12T20:00:00.000Z_2015-09-12T21:00:00.000Z
2015-09-12T21:00:00.000Z_2015-09-12T22:00:00.000Z
2015-09-12T22:00:00.000Z_2015-09-12T23:00:00.000Z
2015-09-12T23:00:00.000Z_2015-09-13T00:00:00.000Z
```

